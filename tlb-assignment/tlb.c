#include <stdlib.h>
#include <stdio.h>
#include <time.h>

#define PAGES (16384)
#define REFS (1024*1024)
#define PAGESIZE 64*64

int main(int argc, char *argv[]){
	clock_t c_start, c_stop;
	
	char *memory = malloc((long)PAGESIZE * PAGES);
	
		for(int p = 0; p < PAGES; p++){
			long ref = (long)p *PAGESIZE;
			
			// force the page to be allocated
			memory[ref]++;
		}
	
	
	printf("#TLB experiment\n");
	printf("#   page size = %d bytes\n", (PAGESIZE));
	printf("#   max pages = %d\n", (PAGES));
	printf("#   total number of references = %d Mi\n", (REFS/(1024*1024)));
	printf("#pages\t proc\t\t sum\n");
	
	//for(int pages = 1; pages <= PAGES; pages += 1)
	for(int pages = 4; pages <= PAGES; pages *= 2){
		
		int loops = REFS / pages;
		c_start = clock();
		
		long sum = 0;
		
		for(int l = 0; l < loops; l++){
			for(int p = 0; p < pages; p++){
				//dummy operation
				sum++;
				
				//replacing dummy operation
				//long ref = (long)p * PAGESIZE;
				//sum += memory[ref];
			}
		}
		c_stop = clock();
		{
			double proc;
			proc = ((double)(c_stop - c_start)) / CLOCKS_PER_SEC;
		
			
			printf("%d\t %.10f\t %ld\n", pages, proc, sum);
		}
	}
	return 0;
}

/* PRINTOUT: 

Without optimization
----------------------------
$ gcc -o tlb tlb.c
$ ./tlb

	#pages	 proc		 sum
	1	 0.006664	 1048576	<----- slightly longer
	2	 0.003238	 1048576	<----- slightly longer
	3	 0.002156	 1048575
	4	 0.002983	 1048576
	5	 0.002187	 1048575
	6	 0.002009	 1048572
	7	 0.001801	 1048572
	8	 0.002242	 1048576
	9	 0.001699	 1048572
	10	 0.001770	 1048570
	11	 0.001836	 1048575
	12	 0.001776	 1048572
	13	 0.001939	 1048567
	14	 0.002304	 1048572
	15	 0.002061	 1048575
	16	 0.002209	 1048576
	





first level optimization -O
----------------------------

$ gcc -o tlb -O tlb.c
$ ./tlb

	#pages	 proc		 sum
	1	 0.001238	 1048576
	2	 0.001991	 1048576
	3	 0.000514	 1048575
	4	 0.000463	 1048576
	5	 0.000571	 1048575
	6	 0.000400	 1048572
	7	 0.000381	 1048572
	8	 0.000627	 1048576
	9	 0.000671	 1048572
	10	 0.000573	 1048570
	11	 0.000338	 1048575
	12	 0.000484	 1048572
	13	 0.000330	 1048567
	14	 0.000353	 1048572
	15	 0.000387	 1048575
	16	 0.000340	 1048576
	
	
	
	

	
$ gcc -o tlb-opt.s -S -O tlb.c
row 1:			.file	"tlb.c"
row 2:			.text

:			: 

row 122:		.long	 0x3
row 123:	3:
row 124:		.align 8
row 125:	4:			<------ more assembler rows = less eff.







$ gcc -o tlb-reg.s -S tlb.c

row 1:			.file	"tlb.c"
row 2:			.text

:		: 

row 98:		.long	 0x3
row 99:	3:
row 100:		.align 8
row 101: 	4:			<------ less assembler rows = more eff.







second level optimization -O2
----------------------------

$ gcc -o tlb -O2 tlb.c
$ ./tlb

	#pages	 proc		 sum
	1	 0.000001	 1048576
	2	 0.000000	 1048576
	3	 0.000001	 1048575
	4	 0.000001	 1048576
	5	 0.000001	 1048575
	6	 0.000001	 1048572
	7	 0.000001	 1048572
	8	 0.000001	 1048576
	9	 0.000001	 1048572
	10	 0.000001	 1048570
	11	 0.000001	 1048575
	12	 0.000000	 1048572
	13	 0.000000	 1048567
	14	 0.000000	 1048572
	15	 0.000001	 1048575
	16	 0.000000	 1048576





accessing a memory reference, 
instead of incrementing 
dummy counter
----------------------------

	#TLB experiment
	#   page size = 64 bytes
	#   max pages = 16
	#   total number of references = 1 Mi
	#pages	 proc		 sum
	1	 0.0010770000	 1048576
	2	 0.0007020000	 1048576
	3	 0.0007110000	 1048575
	4	 0.0009220000	 1048576
	5	 0.0005640000	 1048575
	6	 0.0005000000	 1048572
	7	 0.0004790000	 1048572
	8	 0.0004740000	 1048576
	9	 0.0004380000	 1048572
	10	 0.0004520000	 1048570
	11	 0.0004300000	 1048575
	12	 0.0003840000	 1048572
	13	 0.0003970000	 1048567
	14	 0.0005310000	 1048572
	15	 0.0004160000	 1048575
	16	 0.0004220000	 1048576





PAGESIZE (4*1024)					<----------- 4 KByte pages
----------------------------

	#TLB experiment
	#   page size = 64 bytes
	#   max pages = 16				<------------- 16 pages
	#   total number of references = 1 Mi
	#pages	 proc		 sum
	1	 0.0011340000	 1048576
	2	 0.0008390000	 1048576
	3	 0.0007280000	 1048575
	4	 0.0011180000	 1048576
	5	 0.0006640000	 1048575
	6	 0.0005990000	 1048572
	7	 0.0005270000	 1048572
	8	 0.0004730000	 1048576
	9	 0.0004570000	 1048572
	10	 0.0004280000	 1048570
	11	 0.0004600000	 1048575
	12	 0.0003840000	 1048572
	13	 0.0004340000	 1048567
	14	 0.0004070000	 1048572
	15	 0.0004170000	 1048575
	16	 0.0004920000	 1048576


	#TLB experiment
	#   page size = 64 bytes
	#   max pages = 32				<------------- 32 pages
	#   total number of references = 1 Mi
	#pages	 proc		 sum
	1	 0.0044540000	 1048576
	2	 0.0022500000	 1048576
	3	 0.0033500000	 1048575
	4	 0.0011150000	 1048576
	5	 0.0006300000	 1048575
	6	 0.0004510000	 1048572
	7	 0.0006030000	 1048572
	8	 0.0004820000	 1048576
	9	 0.0004380000	 1048572
	10	 0.0004340000	 1048570
	11	 0.0004030000	 1048575
	12	 0.0005060000	 1048572
	13	 0.0004650000	 1048567
	14	 0.0006340000	 1048572
	15	 0.0004320000	 1048575
	16	 0.0004020000	 1048576
	17	 0.0005760000	 1048560
	18	 0.0004320000	 1048572
	19	 0.0003860000	 1048572
	20	 0.0003840000	 1048560
	21	 0.0004610000	 1048572
	22	 0.0003810000	 1048564
	23	 0.0003810000	 1048570
	24	 0.0004320000	 1048560
	25	 0.0004030000	 1048575
	26	 0.0004310000	 1048554
	27	 0.0003930000	 1048572
	28	 0.0003980000	 1048572
	29	 0.0003980000	 1048553
	30	 0.0003920000	 1048560
	31	 0.0004340000	 1048575
	32	 0.0004000000	 1048576



	#TLB experiment
	#   page size = 64 bytes
	#   max pages = 64				<------------- 64 pages
	#   total number of references = 1 Mi
	#pages	 proc		 sum
	1	 0.0012590000	 1048576
	2	 0.0008170000	 1048576
	3	 0.0007370000	 1048575
	4	 0.0008880000	 1048576
	5	 0.0004790000	 1048575
	6	 0.0004620000	 1048572
	7	 0.0004240000	 1048572
	8	 0.0004140000	 1048576
	9	 0.0004990000	 1048572
	10	 0.0004930000	 1048570
	11	 0.0004040000	 1048575
	12	 0.0003840000	 1048572
	13	 0.0003970000	 1048567
	14	 0.0004230000	 1048572
	15	 0.0004160000	 1048575
	16	 0.0005510000	 1048576
	17	 0.0004070000	 1048560
	18	 0.0008410000	 1048572
	19	 0.0009170000	 1048572
	20	 0.0007190000	 1048560
	21	 0.0004560000	 1048572
	22	 0.0005070000	 1048564
	23	 0.0003930000	 1048570
	24	 0.0005930000	 1048560
	25	 0.0003980000	 1048575
	26	 0.0003950000	 1048554
	27	 0.0004310000	 1048572
	28	 0.0003970000	 1048572
	29	 0.0004080000	 1048553
	30	 0.0003870000	 1048560
	31	 0.0003870000	 1048575
	32	 0.0004940000	 1048576
	33	 0.0004330000	 1048575
	34	 0.0003910000	 1048560
	35	 0.0012890000	 1048565
	36	 0.0003960000	 1048572
	37	 0.0004450000	 1048543
	38	 0.0004390000	 1048572
	39	 0.0005820000	 1048554
	40	 0.0008520000	 1048560
	41	 0.0004620000	 1048575
	42	 0.0009690000	 1048572
	43	 0.0004060000	 1048555
	44	 0.0007780000	 1048564
	45	 0.0004190000	 1048545
	46	 0.0005810000	 1048570
	47	 0.0006320000	 1048570
	48	 0.0005610000	 1048560
	49	 0.0004670000	 1048551
	50	 0.0004960000	 1048550
	51	 0.0006000000	 1048560
	52	 0.0005410000	 1048528
	53	 0.0007590000	 1048552
	54	 0.0006290000	 1048572
	55	 0.0006190000	 1048575
	56	 0.0010130000	 1048544
	57	 0.0006420000	 1048572
	58	 0.0010620000	 1048524
	59	 0.0006620000	 1048548
	60	 0.0004160000	 1048560
	61	 0.0004450000	 1048529
	62	 0.0004870000	 1048544
	63	 0.0004300000	 1048572
	64	 0.0004190000	 1048576







for(int pages = 4; pages <= PAGES; pages *= 2)
----------------------------

	#TLB experiment
	#   page size = 64 bytes
	#   max pages = 64
	#   total number of references = 1 Mi
	#pages	 proc		 sum
	4	 0.0009730000	 1048576
	8	 0.0005330000	 1048576
	16	 0.0004140000	 1048576
	32	 0.0005520000	 1048576
	64	 0.0004990000	 1048576



*/
